# Архитектура системы "Система приёма ТМЦ на склад"

## 1. Общий обзор

Система состоит из двух процессов, работающих на одном компьютере:

1. Сервер (backend):
   - Python 3.12, FastAPI, Uvicorn, SQLite, Peewee.
   - Хранит справочник товаров, приёмки, позиции, ссылки на файлы.
   - Предоставляет REST API для клиента.

2. Клиент (desktop GUI):
   - Python 3.12, PySide6, OpenCV, Tesseract, pdf2image, pdfplumber, requests.
   - Обеспечивает работу оператора склада:
     - загрузка и распознавание ТТН,
     - ручная правка данных,
     - запуск видеозаписи контроля,
     - взаимодействие с API сервера.

Основные директории:

- `server/` — код сервера.
- `client/` — код клиента.
- `common/` — общие Pydantic-модели и enum'ы.
- `config/` — конфигурация.
- `data/` — БД, файлы приёмок, логи.
- `docs/` — документация.

## 2. Сервер

### 2.1. Слой БД (SQLite + Peewee)

- `server/src/db/models.py` — Peewee-модели:
  - `Product` — товары.
  - `Reception` — приёмки.
  - `ReceptionItem` — позиции приёмки.
  - `SyncLog` — лог синхронизации (опционально).

- `server/src/db/migrations.py` — создание таблиц при старте.

- `server/src/db/repository.py` — CRUD-обёртки:
  - поиск товара по артикулу;
  - создание/чтение приёмки и её позиций;
  - обновление путей к файлам;
  - обновление результатов контроля.

### 2.2. Слой схем (Pydantic)

- `server/src/schemas/*.py` — схемы запросов/ответов на основе `common/models.py`.

### 2.3. Слой API (FastAPI роутеры)

- `routes_health.py`:
  - `GET /api/v1/health` — проверка состояния.

- `routes_products.py`:
  - `GET /api/v1/products` — список товаров.
  - `GET /api/v1/products/{article}` — товар по артикулу.

- `routes_receptions.py`:
  - `POST /api/v1/receptions` — создать приёмку.
  - `GET /api/v1/receptions` — список приёмок.
  - `GET /api/v1/receptions/{id}` — детали приёмки.
  - `POST /api/v1/receptions/{id}/control-results` — результаты контроля.

- `routes_files.py`:
  - `POST /api/v1/receptions/{id}/document` — загрузка документа.
  - `POST /api/v1/receptions/{id}/video` — загрузка видео.

- `routes_downloads.py`:
  - `GET /api/v1/receptions/{id}/document` — скачать документ.
  - `GET /api/v1/receptions/{id}/video` — скачать видео.
  - `GET /api/v1/receptions/{id}/items/{item_id}/photos` — скачать все фото товара (ZIP).
  - `GET /api/v1/receptions/{id}/items/{item_id}/photos/{index}` — скачать конкретное фото.

### 2.4. main_server.py

- Инициализирует FastAPI-приложение.
- Подключает роутеры.
- Инициализирует БД.
- Запускает Uvicorn (в dev-режиме через Python или внутри exe).

## 3. Клиент

### 3.1. Сервисы

- `ocr_service.py`:
  - Конвертация PDF → изображения (`pdf2image`).
  - Предобработка (OpenCV).
  - Вызов Tesseract (`pytesseract`) с языком `rus`.
  - Формирование `OCRResult` и списка `ReceptionItemCreate` с пометками `suspicious_fields`.

- `camera_service.py`:
  - Обёртка над `cv2.VideoCapture` и `cv2.VideoWriter`.
  - Методы: поиск камер, открытие/закрытие, превью (через сигнал с QImage), запись AVI (`MJPG`).

- `storage_service.py`:
  - Генерация путей внутри `data/receipts/YYYY-MM-DD_<id>/`.
  - Сохранение документов.
  - Перемещение видео.

- `validator_service.py`:
  - Паттерн Strategy для разных типов контроля (weight_check, quantity_check и т.п.).
  - Выдаёт `ValidationResult`.

- `sync_service.py`:
  - Использует `requests` для обращения к API сервера.
  - Методы:
    - `check_health()`;
    - `create_reception(...)`;
    - `upload_document(...)`;
    - `upload_video(...)`;
    - `send_control_results(...)`.

- `llm_service.py`:
  - Интеграция с OpenAI GPT-4o-mini для анализа документов.
  - Методы:
    - `parse_ttn_text(text)` — парсинг текста ТТН через LLM;
    - `parse_ttn_image(image_path)` — распознавание изображения документа через Vision API.
  - Используется как дополнение к Tesseract OCR для сложных случаев.
  - Требует `OPENAI_API_KEY` в `.env` файле.

### 3.2. UI (PySide6)

- `MainWindow`:
  - Кнопка «Принять ТМЦ на склад».
  - Кнопка «История приёмок».
  - Кнопка «Настройки».
  - Статус-бар (сервер, камера, OCR).

- `DocumentDialog`:
  - **Единое окно приёмки**, объединяющее функции загрузки, OCR и контроля.
  - **Верхняя панель**: Загрузка файла, OCR, Сброс, Просмотр БД.
  - **Область камеры**: `VideoWidget` для записи процесса приёмки.
  - **Область документа**: Предпросмотр PDF/изображения (через `pdf2image`).
  - **Таблица товаров** (`ResultsWidget`): Редактирование, отображение статусов OCR и БД.
  - **Панель проверки**: Инструкции, кнопки "Принять/Отклонить", ввод комментариев.
  - Логика:
    - Загрузка -> OCR -> Проверка товаров (с видео) -> Отправка на сервер.

- `ResultsWidget`:
  - Таблица позиций с цветовой индикацией статусов.
  - Колонки: Артикул, Наименование, Количество, Ед.изм., Статус OCR, Статус БД, Проверено.

- `DatabaseDialog`:
  - Просмотр справочника товаров (`Product`).
  - Поиск и фильтрация.
  - Отображение параметров контроля.

- `VideoWidget`:
  - Отображает кадры, поступающие от `CameraService`.

### 3.3. main_client.py

- Читает конфиг и настраивает логирование.
- Проверяет доступность сервера (`/health`).
- При необходимости запускает сервер как внешний процесс.
- Запускает PySide6-приложение и `MainWindow`.

## 4. Хранение данных

- БД SQLite: `data/database/warehouse.db`.
- Приёмки: `data/receipts/YYYY-MM-DD_<reception_id>/`:
  - `document.pdf` или `document.jpg`;
  - `video.avi`;
  - (опционально) `ocr_result.json`.

Относительные пути к файлам сохраняются в полях `document_path` и `video_path` таблицы `receptions`.

## 5. Основные сценарии работы

### 5.1. Новый приход ТМЦ

1. Оператор запускает сервер и клиент.
2. В клиенте нажимает «Принять ТМЦ на склад».
3. В диалоге загружает документ ТТН.
4. Клиент выполняет OCR и показывает результат.
5. Оператор правит подозрительные поля.
6. Клиент создаёт приёмку через `/receptions` и загружает документ через `/receptions/{id}/document`.
7. При необходимости запускается `ControlDialog`, записывается видео, вводятся данные контроля.
8. Клиент отправляет видео через `/receptions/{id}/video` и результаты контроля через `/receptions/{id}/control-results`.
9. Сервер сохраняет данные и обновляет статус приёмки.

### 5.2. Просмотр истории

1. Оператор открывает «История приёмок».
2. Клиент вызывает `/receptions`, отображает список.
3. При выборе конкретной приёмки вызывает `/receptions/{id}` и показывает детали.

## 6. Нефункциональные требования

- Все ошибки логируются на стороне сервера и клиента.
- Конфиг вынесен в `config/config.json`.
- Структура моделей, эндпоинтов и флоу фиксирована и должна соблюдаться при реализации.
